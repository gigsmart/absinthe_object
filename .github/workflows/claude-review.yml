name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Get the diff for the PR (limit size to avoid token limits)
          git diff origin/${{ github.base_ref }}...HEAD | head -c 50000 > pr_diff.txt

          # Create the review prompt
          cat > review_prompt.txt << 'PROMPT_EOF'
          Review this pull request diff for an Elixir GraphQL library called Absinthe.Object.

          Focus on:
          1. Code quality and Elixir best practices
          2. Potential bugs or edge cases
          3. Documentation completeness
          4. Test coverage suggestions
          5. Security considerations

          Provide actionable feedback. Be constructive and specific.
          Format your response in markdown.

          Here's the diff:
          PROMPT_EOF

          cat pr_diff.txt >> review_prompt.txt

          # Run Claude Code in print mode
          claude -p "$(cat review_prompt.txt)" > review_output.txt 2>&1 || echo "Claude review encountered an error" > review_output.txt

      - name: Post Review Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let review = 'Claude Code Review could not be completed.';
            try {
              review = fs.readFileSync('review_output.txt', 'utf8');
            } catch (e) {
              console.log('Could not read review output:', e);
            }

            // Truncate if too long
            if (review.length > 65000) {
              review = review.substring(0, 65000) + '\n\n...(truncated)';
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Claude Code Review\n\n${review}`
            });
